------------------------------------------------------------------------------
    Overview of the Detailed Network Simulation Infrastructure 
------------------------------------------------------------------------------




------------------------------------------------------------------------------
    Descriptions of Files Involved in Running Scheduler Component with Detailed Network Simulation in SST
------------------------------------------------------------------------------

The files that are used by the detailed simulation infrastructure can be grouped into 4 categories: (i) Input files that are provided by the user, (ii) intermediate files that are generated and updated during the simulation, (iii) output files, (iv) python scripts that provide the interface between scheduler & ember simulations and run them. Next, we explain each category in detail:

(i) Input Files: <example file name located in /scheduler/simulations folder>

	Job trace file: <test_DetailedNetwork.sim>
		this is a list of jobs to run involving the arrival time, number of processors required, estimated running time etc. When running in DetailedNetworkSim mode, an application phase file has to be specified for each job as in the example trace.
	Scheduler input configuration file: <test_DetailedNetwork.py>
		This file includes the scheduler simulation configuration parameters such as the number of nodes, cores per node, the type of scheduler/task mapper to use etc. When running in DetailedNetworkSim mode, the parameters "detailedNetworkSim", "completedJobsTrace", and "runningJobsTrace" must be specified as in the example file. 
	Ember input configuration file: <emberLoad.py>
		This file configures the settings for the ember simulation such as the network topology, the number of nodes, network bandwodth, packet size etc. It includes some other python files from the ember/test directory for default parameters. In order not to copy all those files to our current directory, we add the full path to the directory of these files on line #3 of emberLoad.py. More details on this will be provided later. 
	Application phase file: <CTH_256.phase>
		Each job on the job list has a phase file. Phase file includes a series of motifs that represent the behavior of an application. Example motifs are Halo3D, Allreduce, PingPong etc., and they can be picked from the list of motifs defined in ember.

(ii) Intermediate Files: <example file name located in /scheduler/simulations folder>

	Scheduler snapshot file: <test_DetailedNetwork.sim.snapshot.xml>
		Whenever the scheduler simulation is paused, the scheduler creates/updates a snapshot file. The snapshot file includes information on the jobs that are currently running, the allocation/mapping of the tasks to the nodes, the time of the snapshot etc. A python script parses this information and converts it into a script to run ember.
	Ember output file: <ember.out>
		This file is created/updated at each run of ember simulation. It involves information on how long the ember simulation ran and why it stopped. A python script parses this information and updates the input files to run scheduler.
	Ember load file: <loadfile>
		This is one of the input files used to run ember. loadfile specifies the job numbers, which jobs run on which nodes in ember and the motifs for each job. It is updated before each run of ember.
	Ember motif log files: <motif-0.log>
		Ember simulation can be paused for various reasons. When that happens, we would like to resume ember simulation from where we left. Thus, we create motif logs which record the time whenever a new motif starts running in ember. Using the motif logs, next time we run ember, we continue from the beginning of the motif that was interrupted. For each job, we choose only one node from the node ID list and dump a motif log for the first core of that node. This way, we use the same rank of the application as a reference for application progress and we avoid dealing with too many motif logs.
	Completed/Running job log files: <EmberCompleted.txt> , <EmberRunning.txt>
		Scheduler needs to know the jobs that have completed/ still running in ember. Thus, at the end of each ember run, we update the completed/running job log files. For the jobs that have finished running, we record the actual running time in ember. For the jobs that are still running in ember, we record the running time so far and the current motif number that is running on ember. Scheduler uses this info to update the running times, avoid finishing the currently running jobs etc.

(iii) Output Files: <example file name located in /scheduler/simulations folder>

	Allocation file: <test_DetailedNetwork.sim.alloc>
		This file has the same format as in before. The parameters such as the actual running time, average pairwise L1 distance, job congestion, or hop bytes are based on the previous implementation without detailed network simulation. Thus, this file should be ignored.
	Timing file: <test_DetailedNetwork.sim.time>
		This file has the same format as in before. It includes the actual running time from ember simulation for each job. 

(iv) Python Scripts: <example file name located in /scheduler/simulations folder>

	Main python script: <run_DetailedNetworkSim.py>
		This main python script drives sub-python scripts in order to run scheduler & ember simulations successively until all jobs is the job trace finish running. Two input arguments have to be provided to this script: name of the ember output file (--emberOut) and the name of the scheduler input configuration file (--schedPy).
	Sub-python script to parse scheduler output & run ember: <snapshotParser_sched.py>
		This script parses the scheduler snapshot xml file, updates the ember input files (i.e., the loadfile), creates a script to run ember, and runs ember.
	Sub-python script to parse ember output & run scheduler: <snapshotParser_ember.py>
		This script parses the ember output file, updates the scheduler input files accordingly (i.e., Completed/Running job log files) and runs scheduler.

------------------------------------------------------------------------------
    How to Run The Scheduler Component with Detailed Network Simulation in SST
------------------------------------------------------------------------------

The steps to run are described below:

(1) cd into the /sst/elements/scheduler/simulations directory.

(2) Open the python file named emberLoad.py. In line #3, replace the word PATH with the full path to the ember test directory (i.e., /sst/elements/ember/test). This is done to be able to include the other python files from this folder.

(3) ./run_DetailedNetworkSim.py --emberOut ember.out --schedPy test_DetailedNetwork.py

------------------------------------------------------------------------------
    Important Items to Check Before Running the Detailed Network Simulation
------------------------------------------------------------------------------

-Ember requires all cores of a node to be fully occupied with tasks. Thus, all jobs in the job trace should have the requested number of processors that is an integer multiple of coresPerNode (Ex: If coresPerNode = 4, valid values for the requested number of processors are 4, 8, 12,..., 1000,...).

-Application phase files (Ex: CTH_256.phase) should not include more than a few 100 motifs. As the number of motifs per job and the number of nodes increase, ember runs into memory issues and the simulation gets killed. If simulation of longer jobs are desired, one should increase the number of iterations within a motif as opposed to creating more number of motifs. It is a tradeoff between simulation granularity & simulated time and the resource limitations of the host processor.

-All application phase files should include a "Stop" motif right before the "Fini" motif at the end of the file. See the example CTH_256.phase file for reference.

-The running times in the input job trace should match (i.e., should be within the ballpark of) the actual running times of the applications in ember. If (EmberRunningTime) > (MaximumRequestedTime specified in the job trace), the scheduler will give a fatal error saying "Failed to start job <jobNumber> at guaranteed time".
