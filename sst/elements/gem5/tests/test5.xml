<?xml version="1.0"?>
<sdl version="2.0"/>

<variables>
	<lat> 1ns </lat>
	<buslat> 2 ns </buslat>
    <netlat> 2 ns </netlat>
</variables>

<param_include>
  <l1CacheParams>
      <num_ways> 4 </num_ways>
      <num_rows> 256 </num_rows>
      <blocksize> 64 </blocksize>
      <access_time> 2 ns</access_time>
      <num_upstream> 1 </num_upstream>
      <debug> ${CACHE_DEBUG} </debug>
      <next_level> l2cache </next_level>
      <printStats> 1 </printStats>
  </l1CacheParams>
</param_include>

<sst>
    <component name=system type=gem5.Gem5 rank=0 >
        <params>
            <comp_debug> ${GEM5_DEBUG} </comp_debug>
            <frequency> 1GHz </frequency>
            <cmd> test_fs.py
                --disk-image=linux-x86.img --kernel=x86_64-vmlinux-2.6.22.9.smp
                --script=shutdown_script --mem-size=512MB
                --cpu-type=timing --external-caches --mem-type=InitializerMemory
            </cmd>
            <gem5DebugFlags> ${M5_DEBUG} </gem5DebugFlags>
            <connectors>
                system.cpu.icache system.cpu.dcache
                system.cpu.itb_walker_cache system.cpu.dtb_walker_cache
                system.mem_ctrls.connector
            </connectors>
            <!-- <connectors> system.cpu0.icache system.cpu0.dcache </connectors> -->
        </params>
        <link name=cpu_l1icache_link port=system.cpu.icache latency=$lat />
        <link name=cpu_l1dcache_link port=system.cpu.dcache latency=$lat />
        <link name=cpu_itlbcache_link port=system.cpu.itb_walker_cache latency=$lat />
        <link name=cpu_dtlbcache_link port=system.cpu.dtb_walker_cache latency=$lat />
        <link name=sysbus_cache_link port=system.mem_ctrls.connector latency=$lat />
    </component>

	<component name="Gem5SysBus" type="memHierarchy.Cache">
		<params include=l1CacheParams>
            <debug> ${SYSBUS_DEBUG} </debug>
            <net_addr> 1 </net_addr>
            <next_level />
		</params>
		<link name=sysbus_cache_link port=upstream0 latency=$lat />
		<link name=sysbus_net_link port=directory_link latency=$netlat />
    </component>

	<component name="l1Icache" type="memHierarchy.Cache">
        <params include=l1CacheParams />
		<link name=cpu_l1icache_link port=upstream0 latency=$lat />
		<link name=l1icache_bus_link port=snoop_link latency=$buslat />
	</component>

	<component name="l1Dcache" type="memHierarchy.Cache">
        <params include=l1CacheParams />
		<link name=cpu_l1dcache_link port=upstream0 latency=$lat />
		<link name=l1dcache_bus_link port=snoop_link latency=$buslat />
	</component>

	<component name="ITLBcache" type="memHierarchy.Cache">
        <params include=l1CacheParams />
		<link name=cpu_itlbcache_link port=upstream0 latency=$lat />
		<link name=itlbcache_bus_link port=snoop_link latency=$buslat />
	</component>

	<component name="DTLBcache" type="memHierarchy.Cache">
        <params include=l1CacheParams />
		<link name=cpu_dtlbcache_link port=upstream0 latency=$lat />
		<link name=dtlbcache_bus_link port=snoop_link latency=$netlat />
	</component>

	<component name="membus" type="memHierarchy.Bus">
		<params>
			<numPorts> 5 </numPorts>
			<busDelay> 1 ns </busDelay>
            <atomicDelivery> 1 </atomicDelivery>
            <debug> ${BUS_DEBUG} </debug>
		</params>
		<link name=l1icache_bus_link port=port0 latency=$buslat />
		<link name=l1dcache_bus_link port=port1 latency=$buslat />
		<link name=itlbcache_bus_link port=port2 latency=$buslat />
		<link name=dtlbcache_bus_link port=port3 latency=$buslat />
		<link name=l2cache_bus_link port=port4 latency=$buslat />
	</component>

	<component name="l2cache" type="memHierarchy.Cache">
		<params>
			<num_ways> 8 </num_ways>
			<num_rows> 2048 </num_rows>
			<blocksize> 64 </blocksize>
			<access_time> 5 ns </access_time>
            <debug> ${L2_DEBUG} </debug>
            <printStats> 1 </printStats>
            <net_addr> 2 </net_addr>
		</params>
		<link name=l2cache_bus_link port=snoop_link latency=$buslat />
		<link name=l2cache_net_link port=directory_link latency=$buslat />
	</component>

    <component name="chiprtr" type="merlin.hr_router">
        <params>
            <num_ports> 3 </num_ports>
            <num_vcs> 3 </num_vcs>
            <link_bw> 5GHz </link_bw>
            <xbar_bw> 5GHz </xbar_bw>
            <topology> merlin.singlerouter </topology>
            <id> 0 </id>
        </params>
        <link name=dir_net_link port=port0 latency=$netlat />
        <link name=l2cache_net_link port=port2 latency=$netlat />
        <link name=sysbus_net_link port=port1 latency=$netlat />
    </component>


    <component name="dirctrl" type="memHierarchy.DirectoryController">
        <params>
            <network_addr> 0 </network_addr>
            <network_bw> 1GHz </network_bw>
            <clock> 2GHz </clock>
            <addrRangeStart> 0x0 </addrRangeStart>
            <addrRangeEnd> 0x20000000 </addrRangeEnd> <!-- 512MB - 16MB for backingStoreSize -->
            <entryCacheSize> 1048576 </entryCacheSize>
            <backingStoreSize> 0x0000000 </backingStoreSize> <!-- 16 MB -->
            <debug> ${MEM_DEBUG} </debug>
        </params>
        <link name=dir_mem_link port=memory latency=$buslat />
        <link name=dir_net_link port=network latency=$netlat />
    </component>

	<component name="memory" type="memHierarchy.MemController">
		<params>
			<access_time> 10 ns </access_time>
			<mem_size> 512 </mem_size>
			<clock> 2GHz </clock>
            <debug> ${MEM_DEBUG} </debug>
		</params>
		<link name=dir_mem_link port=direct_link latency=$buslat />
	</component>
</sst>
